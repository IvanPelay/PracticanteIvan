-- ===================================================================
-- Script: Creación de tablas para Módulo Reporteador Automático
-- Sistema: KROM - Automatización de Reportes Aduanales
-- Familia: 016 (Reportes)
-- Versión: Alternativa - Basada en rutas de plantilla y configuración
-- Autor: Residencia Profesional
-- Fecha: Febrero 2026
-- Base de datos: KROM_Solium / KROM_Reporteador (según corresponda)
-- ===================================================================

USE [KROM_Solium]  -- ← Cambiar por la BD destino
GO

-- ===================================================================
-- 1. CATÁLOGO DE PLANTILLAS DE REPORTE
--    Almacena la definición lógica del reporte: rutas de plantilla Excel,
--    configuración, consulta SQL, parámetros, etc.
-- ===================================================================
CREATE TABLE [dbo].[Cat016PlantillasReporteador] (
    -- Llave primaria
    i_Cve_Plantilla INT IDENTITY(1,1) NOT NULL,
    
    -- Datos generales
    t_Nombre VARCHAR(200) NOT NULL,
    t_RutaPlantilla VARCHAR(500) NOT NULL,     -- Ruta del archivo Excel plantilla
    t_RutaConfig VARCHAR(500) NOT NULL,        -- Ruta del archivo de configuración JSON
    t_NombreBaseDatos VARCHAR(100) NOT NULL,   -- Base de datos destino para la consulta
    t_Consulta TEXT NOT NULL,                  -- Consulta SQL parametrizada
    t_ParametrosConfig VARCHAR(MAX) NULL,      -- JSON con configuración de parámetros
    t_FormatoSalida VARCHAR(10) NOT NULL CONSTRAINT DF_Cat016_FormatoSalida DEFAULT ('XLSX'),
    
    -- Estado y auditoría
    i_Cve_Estado INT NOT NULL CONSTRAINT DF_Cat016_Estado DEFAULT (1),
    f_FechaRegistro DATETIME NOT NULL CONSTRAINT DF_Cat016_FechaRegistro DEFAULT (GETDATE()),
    t_UsuarioRegistro VARCHAR(50) NOT NULL CONSTRAINT DF_Cat016_UsuarioRegistro DEFAULT (''),
    f_FechaModificacion DATETIME NULL,
    t_UsuarioModificacion VARCHAR(50) NULL,
    
    -- Restricciones
    CONSTRAINT PK_Cat016PlantillasReporteador PRIMARY KEY CLUSTERED (i_Cve_Plantilla ASC),
    CONSTRAINT CK_Cat016_Formato CHECK (t_FormatoSalida IN ('XLSX', 'XLS', 'CSV', 'PDF')),
    CONSTRAINT CK_Cat016_Estado CHECK (i_Cve_Estado IN (0, 1))  -- 0 = Inactivo, 1 = Activo
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

-- ÍNDICES
CREATE NONCLUSTERED INDEX IX_Cat016_Nombre ON [dbo].[Cat016PlantillasReporteador] (t_Nombre) WHERE i_Cve_Estado = 1
GO
CREATE NONCLUSTERED INDEX IX_Cat016_Estado ON [dbo].[Cat016PlantillasReporteador] (i_Cve_Estado)
GO
CREATE NONCLUSTERED INDEX IX_Cat016_BaseDatos ON [dbo].[Cat016PlantillasReporteador] (t_NombreBaseDatos)
GO
CREATE NONCLUSTERED INDEX IX_Cat016_Formato ON [dbo].[Cat016PlantillasReporteador] (t_FormatoSalida)
GO

-- DESCRIPCIÓN DE TABLA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Catálogo de plantillas de reportes con rutas de archivo Excel y configuración externa',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador';
GO

-- DESCRIPCIONES DE COLUMNAS
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave única de la plantilla', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Plantilla';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Nombre descriptivo de la plantilla', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_Nombre';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Ruta del archivo Excel que sirve como plantilla', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_RutaPlantilla';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Ruta del archivo JSON con configuración de la plantilla', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_RutaConfig';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Nombre de la base de datos donde se ejecutará la consulta', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_NombreBaseDatos';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Consulta SQL parametrizada que obtiene los datos', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_Consulta';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'JSON con configuración de parámetros de la consulta', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_ParametrosConfig';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Formato de archivo de salida: XLSX, XLS, CSV, PDF', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N't_FormatoSalida';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Estatus: 1=Activo, 0=Inactivo', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cat016PlantillasReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Estado';
GO

-- ===================================================================
-- 2. VALIDACIONES POR PLANTILLA
--    Reglas de negocio que se ejecutarán antes de generar el reporte.
--    Cada validación es reutilizable y configurable vía JSON.
-- ===================================================================
CREATE TABLE [dbo].[Enc016ValidacionesReporteador] (
    i_Cve_Validacion INT IDENTITY(1,1) NOT NULL,
    i_Cve_Plantilla INT NOT NULL,
    
    t_Tipo VARCHAR(50) NOT NULL,  -- 'registros_minimos', 'campos_obligatorios', 'totales', 'nulos', 'personalizada'
    t_Configuracion NVARCHAR(MAX) NOT NULL,  -- JSON con umbrales, campos, condiciones
    i_Orden INT NOT NULL CONSTRAINT DF_Enc016_Orden DEFAULT (1),
    t_MensajeError VARCHAR(500) NULL,        -- Mensaje personalizado para esta validación
    
    i_Cve_Estado INT NOT NULL CONSTRAINT DF_Enc016_Estado DEFAULT (1),
    f_FechaRegistro DATETIME NOT NULL CONSTRAINT DF_Enc016_FechaRegistro DEFAULT (GETDATE()),
    t_UsuarioRegistro VARCHAR(50) NOT NULL CONSTRAINT DF_Enc016_UsuarioRegistro DEFAULT (''),
    f_FechaModificacion DATETIME NULL,
    t_UsuarioModificacion VARCHAR(50) NULL,
    
    CONSTRAINT PK_Enc016ValidacionesReporteador PRIMARY KEY CLUSTERED (i_Cve_Validacion ASC),
    CONSTRAINT FK_Enc016_Plantilla FOREIGN KEY (i_Cve_Plantilla) 
        REFERENCES [dbo].[Cat016PlantillasReporteador] (i_Cve_Plantilla),
    CONSTRAINT CK_Enc016_Estado CHECK (i_Cve_Estado IN (0, 1))
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

-- ÍNDICES
CREATE NONCLUSTERED INDEX IX_Enc016_Plantilla ON [dbo].[Enc016ValidacionesReporteador] (i_Cve_Plantilla)
GO
CREATE NONCLUSTERED INDEX IX_Enc016_Tipo ON [dbo].[Enc016ValidacionesReporteador] (t_Tipo)
GO
CREATE NONCLUSTERED INDEX IX_Enc016_Orden ON [dbo].[Enc016ValidacionesReporteador] (i_Orden)
GO
CREATE NONCLUSTERED INDEX IX_Enc016_Estado ON [dbo].[Enc016ValidacionesReporteador] (i_Cve_Estado)
GO

-- DESCRIPCIÓN DE TABLA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Validaciones aplicables a cada plantilla de reporte',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador';
GO

-- DESCRIPCIONES DE COLUMNAS
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave única de la validación', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Validacion';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave de la plantilla asociada (FK)', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Plantilla';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Tipo de validación: registros_minimos, campos_obligatorios, totales, nulos, personalizada', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador', @level2type = N'COLUMN', @level2name = N't_Tipo';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'JSON con configuración específica de la validación', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador', @level2type = N'COLUMN', @level2name = N't_Configuracion';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Orden de ejecución de la validación', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador', @level2type = N'COLUMN', @level2name = N'i_Orden';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Mensaje de error personalizado', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ValidacionesReporteador', @level2type = N'COLUMN', @level2name = N't_MensajeError';
GO

-- ===================================================================
-- 3. CONFIGURACIÓN GENERAL DEL MÓDULO REPORTEADOR
--    Parámetros globales: rutas, timeout, límites, SMTP, etc.
-- ===================================================================
CREATE TABLE [dbo].[Cng016ConfigReporteador] (
    i_Cve_Config INT IDENTITY(1,1) NOT NULL,
    t_Clave VARCHAR(50) NOT NULL,
    t_Valor VARCHAR(500) NOT NULL CONSTRAINT DF_Cng016_Valor DEFAULT (''),
    t_Descripcion VARCHAR(200) NOT NULL CONSTRAINT DF_Cng016_Descripcion DEFAULT (''),
    t_Grupo VARCHAR(50) NULL CONSTRAINT DF_Cng016_Grupo DEFAULT ('GENERAL'),
    
    i_Cve_Estado INT NOT NULL CONSTRAINT DF_Cng016_Estado DEFAULT (1),
    f_Actualizacion DATETIME NOT NULL CONSTRAINT DF_Cng016_Actualizacion DEFAULT (GETDATE()),
    t_UsuarioActualizacion VARCHAR(50) NOT NULL CONSTRAINT DF_Cng016_UsuarioActualizacion DEFAULT (''),
    
    CONSTRAINT PK_Cng016ConfigReporteador PRIMARY KEY CLUSTERED (i_Cve_Config ASC),
    CONSTRAINT UQ_Cng016_Clave UNIQUE (t_Clave),
    CONSTRAINT CK_Cng016_Estado CHECK (i_Cve_Estado IN (0, 1))
) ON [PRIMARY]
GO

-- ÍNDICES
CREATE NONCLUSTERED INDEX IX_Cng016_Clave ON [dbo].[Cng016ConfigReporteador] (t_Clave)
GO
CREATE NONCLUSTERED INDEX IX_Cng016_Grupo ON [dbo].[Cng016ConfigReporteador] (t_Grupo)
GO
CREATE NONCLUSTERED INDEX IX_Cng016_Estado ON [dbo].[Cng016ConfigReporteador] (i_Cve_Estado)
GO

-- DESCRIPCIÓN DE TABLA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Configuración global del módulo reporteador',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Cng016ConfigReporteador';
GO

-- ===================================================================
-- 4. PROGRAMACIÓN DE EJECUCIONES
--    Define cuándo y con qué parámetros fijos se ejecuta una plantilla.
-- ===================================================================
CREATE TABLE [dbo].[Enc016ProgramacionReporteador] (
    i_Cve_Programacion INT IDENTITY(1,1) NOT NULL,
    i_Cve_Plantilla INT NOT NULL,
    
    t_Nombre VARCHAR(150) NOT NULL,
    t_Descripcion VARCHAR(500) NULL,
    t_Frecuencia CHAR(1) NOT NULL,  -- 'U'=Única, 'D'=Diaria, 'S'=Semanal, 'M'=Mensual, 'P'=Personalizada
    t_DiasSemana VARCHAR(20) NULL,  -- '1,3,5' = Lunes, Miércoles, Viernes (para frecuencia semanal)
    t_DiaMes INT NULL,              -- Día del mes (para frecuencia mensual)
    t_Hora TIME NOT NULL,
    t_Parametros VARCHAR(MAX) NULL, -- JSON con valores fijos para los parámetros de la plantilla
    i_MaximoIntentos INT NOT NULL CONSTRAINT DF_Enc016_Intentos DEFAULT (3),
    
    i_Cve_Estado INT NOT NULL CONSTRAINT DF_Enc016_EstadoProgramacion DEFAULT (1),
    f_ProximaEjecucion DATETIME NULL,
    f_UltimaEjecucion DATETIME NULL,
    f_FechaRegistro DATETIME NOT NULL CONSTRAINT DF_Enc016_FechaRegistroProgramacion DEFAULT (GETDATE()),
    t_UsuarioRegistro VARCHAR(50) NOT NULL CONSTRAINT DF_Enc016_UsuarioRegistroProgramacion DEFAULT (''),
    f_FechaModificacion DATETIME NULL,
    t_UsuarioModificacion VARCHAR(50) NULL,
    
    CONSTRAINT PK_Enc016ProgramacionReporteador PRIMARY KEY CLUSTERED (i_Cve_Programacion ASC),
    CONSTRAINT FK_Enc016_PlantillaProgramacion FOREIGN KEY (i_Cve_Plantilla) 
        REFERENCES [dbo].[Cat016PlantillasReporteador] (i_Cve_Plantilla),
    CONSTRAINT CK_Enc016_Frecuencia CHECK (t_Frecuencia IN ('U', 'D', 'S', 'M', 'P')),
    CONSTRAINT CK_Enc016_DiaSemana CHECK (t_DiasSemana IS NULL OR t_DiasSemana LIKE '[0-9]%' OR t_DiasSemana = ''),
    CONSTRAINT CK_Enc016_DiaMes CHECK (t_DiaMes IS NULL OR (t_DiaMes BETWEEN 1 AND 31)),
    CONSTRAINT CK_Enc016_EstadoProgramacion CHECK (i_Cve_Estado IN (0, 1))
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

-- ÍNDICES
CREATE NONCLUSTERED INDEX IX_Enc016_ProximaEjecucion ON [dbo].[Enc016ProgramacionReporteador] (f_ProximaEjecucion) 
    WHERE i_Cve_Estado = 1 AND f_ProximaEjecucion IS NOT NULL
GO
CREATE NONCLUSTERED INDEX IX_Enc016_PlantillaProgramacion ON [dbo].[Enc016ProgramacionReporteador] (i_Cve_Plantilla)
GO
CREATE NONCLUSTERED INDEX IX_Enc016_Frecuencia ON [dbo].[Enc016ProgramacionReporteador] (t_Frecuencia)
GO
CREATE NONCLUSTERED INDEX IX_Enc016_Estado ON [dbo].[Enc016ProgramacionReporteador] (i_Cve_Estado)
GO

-- DESCRIPCIÓN DE TABLA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Programaciones de ejecución de reportes',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador';
GO

-- DESCRIPCIONES DE COLUMNAS
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave única de la programación', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Programacion';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave de la plantilla asociada (FK)', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Plantilla';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Nombre descriptivo de la programación', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N't_Nombre';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Frecuencia de ejecución: U=Única, D=Diaria, S=Semanal, M=Mensual, P=Personalizada', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N't_Frecuencia';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Días de la semana (1=Domingo, 2=Lunes, ..., 7=Sábado) en formato "1,3,5"', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N't_DiasSemana';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Día del mes (1-31) para frecuencia mensual', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N't_DiaMes';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Hora de ejecución', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N't_Hora';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'JSON con valores fijos para los parámetros', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N't_Parametros';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Número máximo de intentos en caso de fallo', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Enc016ProgramacionReporteador', @level2type = N'COLUMN', @level2name = N'i_MaximoIntentos';
GO

-- ===================================================================
-- 5. DESTINATARIOS POR PROGRAMACIÓN
--    Correos electrónicos que recibirán el reporte (éxito) o alertas (error).
--    Manejo explícito de cadenas vacías vs NULL.
-- ===================================================================
CREATE TABLE [dbo].[Det016DestinatariosReporteador] (
    i_Cve_Destinatario INT IDENTITY(1,1) NOT NULL,
    i_Cve_Programacion INT NOT NULL,
    
    t_Nombre VARCHAR(150) NOT NULL CONSTRAINT DF_Det016_Nombre DEFAULT (''),
    t_Correo VARCHAR(200) NOT NULL,
    t_TipoDestino CHAR(1) NOT NULL CONSTRAINT DF_Det016_TipoDestino DEFAULT ('P'),  -- 'P' = Para, 'C' = CC, 'O' = CCO
    t_TipoNotificacion CHAR(1) NOT NULL CONSTRAINT DF_Det016_TipoNotificacion DEFAULT ('A'), -- 'E' = Éxito, 'F' = Fallo, 'A' = Ambos
    i_Orden INT NOT NULL CONSTRAINT DF_Det016_Orden DEFAULT (1),
    
    i_Cve_Estado INT NOT NULL CONSTRAINT DF_Det016_Estado DEFAULT (1),
    f_FechaRegistro DATETIME NOT NULL CONSTRAINT DF_Det016_FechaRegistro DEFAULT (GETDATE()),
    t_UsuarioRegistro VARCHAR(50) NOT NULL CONSTRAINT DF_Det016_UsuarioRegistro DEFAULT (''),
    f_FechaModificacion DATETIME NULL,
    t_UsuarioModificacion VARCHAR(50) NULL,
    
    CONSTRAINT PK_Det016DestinatariosReporteador PRIMARY KEY CLUSTERED (i_Cve_Destinatario ASC),
    CONSTRAINT FK_Det016_Programacion FOREIGN KEY (i_Cve_Programacion) 
        REFERENCES [dbo].[Enc016ProgramacionReporteador] (i_Cve_Programacion),
    CONSTRAINT CK_Det016_TipoDestino CHECK (t_TipoDestino IN ('P', 'C', 'O')),
    CONSTRAINT CK_Det016_TipoNotificacion CHECK (t_TipoNotificacion IN ('E', 'F', 'A')),
    CONSTRAINT CK_Det016_Estado CHECK (i_Cve_Estado IN (0, 1)),
    CONSTRAINT CK_Det016_Correo CHECK (t_Correo LIKE '%_@__%.__%') -- Validación básica de email
) ON [PRIMARY]
GO

-- ÍNDICES
CREATE NONCLUSTERED INDEX IX_Det016_Programacion ON [dbo].[Det016DestinatariosReporteador] (i_Cve_Programacion)
GO
CREATE NONCLUSTERED INDEX IX_Det016_Correo ON [dbo].[Det016DestinatariosReporteador] (t_Correo)
GO
CREATE NONCLUSTERED INDEX IX_Det016_TipoDestino ON [dbo].[Det016DestinatariosReporteador] (t_TipoDestino)
GO
CREATE NONCLUSTERED INDEX IX_Det016_TipoNotificacion ON [dbo].[Det016DestinatariosReporteador] (t_TipoNotificacion)
GO

-- DESCRIPCIÓN DE TABLA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Destinatarios de correo por programación de reporte',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Det016DestinatariosReporteador';
GO

-- ===================================================================
-- 6. BITÁCORA DE GENERACIONES
--    Registro histórico de cada ejecución del reporteador.
--    Aquí NO se usa DEFAULT '' en t_Error; se usa NULL para indicar "sin error".
-- ===================================================================
CREATE TABLE [dbo].[Bit016GeneracionReporteador] (
    i_Cve_Generacion INT IDENTITY(1,1) NOT NULL,
    i_Cve_Programacion INT NOT NULL,
    
    f_FechaInicio DATETIME NOT NULL CONSTRAINT DF_Bit016_FechaInicio DEFAULT (GETDATE()),
    f_FechaFin DATETIME NULL,
    t_Estatus VARCHAR(20) NOT NULL,  -- 'PROCESANDO', 'COMPLETADO', 'FALLIDO', 'VALIDACION_FALLIDA'
    i_RegistrosProcesados INT NOT NULL CONSTRAINT DF_Bit016_Registros DEFAULT (0),
    t_RutaDocumento VARCHAR(500) NULL,
    t_IdDocumento VARCHAR(50) NULL,  -- ID en Paperless / KromBase
    t_Error TEXT NULL,               -- NULL = sin error
    t_ParametrosUsados VARCHAR(MAX) NULL,  -- JSON con los parámetros reales usados en esta ejecución
    f_FechaRegistro DATETIME NOT NULL CONSTRAINT DF_Bit016_FechaRegistro DEFAULT (GETDATE()),
    
    CONSTRAINT PK_Bit016GeneracionReporteador PRIMARY KEY CLUSTERED (i_Cve_Generacion ASC),
    CONSTRAINT FK_Bit016_Programacion FOREIGN KEY (i_Cve_Programacion) 
        REFERENCES [dbo].[Enc016ProgramacionReporteador] (i_Cve_Programacion),
    CONSTRAINT CK_Bit016_Estatus CHECK (t_Estatus IN ('PROCESANDO', 'COMPLETADO', 'FALLIDO', 'VALIDACION_FALLIDA'))
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

-- ÍNDICES
CREATE NONCLUSTERED INDEX IX_Bit016_ProgramacionFecha ON [dbo].[Bit016GeneracionReporteador] (i_Cve_Programacion, f_FechaInicio)
GO
CREATE NONCLUSTERED INDEX IX_Bit016_Estatus ON [dbo].[Bit016GeneracionReporteador] (t_Estatus)
GO
CREATE NONCLUSTERED INDEX IX_Bit016_FechaInicio ON [dbo].[Bit016GeneracionReporteador] (f_FechaInicio)
GO
CREATE NONCLUSTERED INDEX IX_Bit016_FechaFin ON [dbo].[Bit016GeneracionReporteador] (f_FechaFin)
GO

-- DESCRIPCIÓN DE TABLA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Bitácora de generaciones de reportes',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador';
GO

-- DESCRIPCIONES DE COLUMNAS
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave única de la generación', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Generacion';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Clave de la programación asociada (FK)', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N'i_Cve_Programacion';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Fecha y hora de inicio de ejecución', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N'f_FechaInicio';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Fecha y hora de fin de ejecución', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N'f_FechaFin';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Estatus de la ejecución: PROCESANDO, COMPLETADO, FALLIDO, VALIDACION_FALLIDA', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N't_Estatus';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Número de registros procesados', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N'i_RegistrosProcesados';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Ruta del documento generado', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N't_RutaDocumento';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'ID del documento en Paperless', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N't_IdDocumento';
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Detalle del error (NULL = sin error)', 
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Bit016GeneracionReporteador', @level2type = N'COLUMN', @level2name = N't_Error';
GO

-- ===================================================================
-- 7. DATOS INICIALES (MÍNIMOS PARA OPERACIÓN)
-- ===================================================================
INSERT INTO [dbo].[Cng016ConfigReporteador] (t_Clave, t_Valor, t_Descripcion, t_Grupo, t_UsuarioActualizacion)
VALUES
    -- RUTAS DEL SISTEMA
    ('RUTA_BASE_PLANTILLAS', '\\servidor\plantillas\', 'Ruta base para almacenar plantillas Excel', 'RUTAS', 'SISTEMA'),
    ('RUTA_BASE_CONFIG', '\\servidor\config\', 'Ruta base para archivos de configuración JSON', 'RUTAS', 'SISTEMA'),
    ('RUTA_DOCUMENTOS_TEMP', 'C:\Temp\Reporteador\', 'Ruta temporal para generación de archivos', 'RUTAS', 'SISTEMA'),
    ('RUTA_DOCUMENTOS_FINAL', '\\servidor\reportes\', 'Ruta final para almacenamiento', 'RUTAS', 'SISTEMA'),
    ('RETENCION_DIAS', '90', 'Días de retención de reportes generados', 'RUTAS', 'SISTEMA'),
    
    -- CONFIGURACIÓN GENERAL
    ('TIEMPO_MAXIMO_EJECUCION_SEG', '300', 'Tiempo máximo de ejecución por reporte (segundos)', 'GENERAL', 'SISTEMA'),
    ('REGISTROS_MAXIMOS_EXCEL', '100000', 'Límite de registros para exportación a Excel', 'GENERAL', 'SISTEMA'),
    ('INTENTOS_FALLIDOS', '3', 'Número de intentos antes de desactivar programación', 'GENERAL', 'SISTEMA'),
    
    -- CONFIGURACIÓN DE CORREO
    ('SMTP_SERVIDOR', 'smtp.krom.com.mx', 'Servidor SMTP para envío de correos', 'CORREO', 'SISTEMA'),
    ('SMTP_PUERTO', '587', 'Puerto SMTP', 'CORREO', 'SISTEMA'),
    ('SMTP_SSL', '1', 'Usar SSL (1=SI, 0=NO)', 'CORREO', 'SISTEMA'),
    ('SMTP_USUARIO', 'reporteador@krom.com.mx', 'Usuario SMTP', 'CORREO', 'SISTEMA'),
    ('SMTP_PASSWORD_ENCRIPTADO', '', 'Contraseña encriptada SMTP', 'CORREO', 'SISTEMA'),
    ('CORREO_EMISOR', 'reporteador@krom.com.mx', 'Cuenta remitente para correos', 'CORREO', 'SISTEMA'),
    
    -- INTEGRACIÓN CON PAPERLESS
    ('INTEGRACION_PAPERLESS', '1', 'Activar integración con Paperless (1=SI, 0=NO)', 'INTEGRACION', 'SISTEMA'),
    ('PAPERLESS_URL', 'http://paperless/api', 'URL de API de Paperless', 'INTEGRACION', 'SISTEMA'),
    ('PAPERLESS_API_KEY', '', 'API Key para Paperless', 'INTEGRACION', 'SISTEMA')
GO

-- ===================================================================
-- 8. VISTA ÚTIL: Programaciones activas con próxima ejecución
-- ===================================================================
CREATE VIEW [dbo].[Vig016ProgramacionesPendientes] AS
SELECT 
    p.i_Cve_Programacion,
    p.t_Nombre,
    p.t_Frecuencia,
    p.t_Hora,
    p.f_ProximaEjecucion,
    pl.i_Cve_Plantilla,
    pl.t_Nombre AS t_NombrePlantilla,
    pl.t_RutaPlantilla,
    pl.t_RutaConfig,
    pl.t_NombreBaseDatos,
    pl.t_Consulta,
    pl.t_ParametrosConfig,
    pl.t_FormatoSalida
FROM [dbo].[Enc016ProgramacionReporteador] p
INNER JOIN [dbo].[Cat016PlantillasReporteador] pl ON p.i_Cve_Plantilla = pl.i_Cve_Plantilla
WHERE p.i_Cve_Estado = 1 
  AND pl.i_Cve_Estado = 1
  AND p.f_ProximaEjecucion IS NOT NULL
  AND p.f_ProximaEjecucion <= GETDATE()
GO

-- DESCRIPCIÓN DE VISTA
EXEC sp_addextendedproperty @name = N'MS_Description', @value = N'Vista de programaciones activas listas para ejecutar',
    @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'Vig016ProgramacionesPendientes';
GO

-- ===================================================================
-- 9. RESUMEN DE CREACIÓN
-- ===================================================================
PRINT '========================================================='
PRINT 'MÓDULO REPORTEADOR KROM - FAMILIA 016'
PRINT 'Versión: Basada en rutas de plantilla y configuración'
PRINT '========================================================='
PRINT 'Tablas creadas: 6'
PRINT 'Índices creados: 21'
PRINT 'Restricciones: 30+'
PRINT 'Descripciones de tabla: 6'
PRINT 'Descripciones de columna: 30+'
PRINT 'Configuraciones iniciales: 17'
PRINT 'Vistas creadas: 1'
PRINT '========================================================='
PRINT 'Script ejecutado exitosamente.'
PRINT '========================================================='
GO